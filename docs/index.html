<html>
  <head>
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">
<meta name="msapplication-TileColor" content="#00aba9">
<meta name="theme-color" content="#ffffff">
<style>
body {
  margin: 0;
}

#editor {
  height: 50%;
}

#output {
  margin: 0;
  height: 50%;
  overflow-y: scroll;
  background-color: #002b36;
  color: #fdf6e3;
}
</style>

  </head>
  <body>

<script src="ace.js" type="text/javascript" charset="utf-8"></script>
<div id="editor">class A
  sig(foo: Integer).returns(String)
  def bar(foo)
    foo.to_s
  end
end

def main
  A.new.barr(91)
  A.new.bar("91")
end</div>
<script>
  var editor = ace.edit("editor", {
    printMargin: false,
  });
  editor.setTheme("ace/theme/monokai");
  editor.session.setMode("ace/mode/ruby");
  editor.session.on("change", function() {
    typecheck();
  });
</script>

<script src="ansi_up.js" type="text/javascript"></script>
<pre id="output">
</pre>

<script>
(function() {
  var output = document.getElementById('output');
  var runId = 0;
  var curId = 0;
  var ansi_up = new AnsiUp;
  var sorbetModuleCompile = fetch('sorbet.wasm').then(response =>
    response.arrayBuffer()
  ).then(bytes =>
    WebAssembly.compile(bytes)
  )

  var print = function(line) {
    if (runId != curId) {
      return;
    }
    output.innerHTML += ansi_up.ansi_to_html(line) + "\n";
  };
  var sorbet = null;
  var typecheckOnLoad = false;

  // Returns a function, that, as long as it continues to be invoked, will not
  // be triggered. The function will be called after it stops being called for
  // N milliseconds. If `immediate` is passed, trigger the function on the
  // leading edge, instead of the trailing.
  function debounce(func, wait, immediate) {
    var timeout;
    return function() {
      var context = this, args = arguments;
      var later = function() {
        timeout = null;
        if (!immediate) func.apply(context, args);
      };
      var callNow = immediate && !timeout;
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
      if (callNow) func.apply(context, args);
    };
  };

  function compile() {
    if (sorbet) {
      // Already compiling or compiled
      return sorbet;
    }
    // For some unkonwn reason this varible has to be new everytime, and can't
    // be out of the closure
    var opts = {
      print: function(line) {
        print(line);
      },

      printErr: function(line) {
        line = line.replace(/.*\[error\] /, '')
        line = line.replace(/http:\/\/[^ ]*/, '')
        line = line.replace('git.corp.stripe.com/stripe-internal', 'github.com/stripe')
        print(line);
      },
      instantiateWasm: function(info, realRecieveInstanceCallBack) {
        sorbetModuleCompile.then(module => WebAssembly.instantiate(module, info).then(instance =>
          realRecieveInstanceCallBack(instance, module)).catch(error => console.error(error)))
        return {}; // indicates lazy initialization
      },
    };

    sorbet = Sorbet(opts);
    return sorbet;
  }

  function typecheck() {
    debounce(function() {
      typecheckOnLoad = true;
      compile().then(compileCB);
    }, 250)();
  }

  function compileCB(Module) {
    if (!typecheckOnLoad) {
      return;
    }
    typecheckOnLoad = false;
    // We somehow use up the WASM instance by calling this function so we have
    // to null it out and recompile
    sorbet = null;
    output.innerText = "";

    runId += 1;
    curId = runId;
    var f = Module.cwrap('typecheck', null, ['string']);
    var ruby = editor.getValue();
    f(ruby);

    // Eagerly compile a new copy
    compile();
  }

  window.typecheck = typecheck;
})();
</script>
<script>
function async(u, c) {
  var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
  o.src = u;
  if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
  s.parentNode.insertBefore(o, s);
}
async("sorbet.js", typecheck);
</script>

  </body>
</html>
